<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./shared-styles.html">

<link rel="import" href="./tank/blaktip-tank.html">
<link rel="import" href="./tank/blaktip-tank-editor.html">
<link rel="import" href="./tank/blaktip-tank-behavior.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">


<dom-module id="tanks-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

    </style>

   <!--Tanks Query -->
   <!-- <firebase-document
       id="document2"
       app-name="blaktip"
       path="[[editableTanksId]]"
       data="{{editableTank}}">
    </firebase-document> -->
    <!-- Todo fix UID probelme here - needs to use user.uid  -->
    <!-- <firebase-query
       id="query1"
       app-name="blaktip"
       path="/tanks/[[user.uid]]" 
       data="{{data}}">
    </firebase-query>

    <firebase-query
       id="query2"
       app-name="blaktip"
       path="/measurements/[[user.uid]]"
       data="{{measurements}}">
    </firebase-query>
    <app-indexeddb-mirror
       session="user.uid"
       key="rooms"
       data="{{data}}"
       persisted-data="{{persistedRooms}}">
    </app-indexeddb-mirror>

     <template is="dom-repeat" items="[[data]]" as="tank">
        <template is="dom-repeat" items="[[measurements]]" as="measurement">
          <blaktip-tank
           id$="[[tank.$key]]"
           title="[[tank.name]]"
           body="[[tank.desc]"
           temperature="[[tank.temp]]"
           on-tap="edit">
          </blaktip-tank>
        </template>
     </template> -->


    <firebase-query
       id="query1"
       app-name="blaktip"
       path="/users/[[user.uid]]/tanks" 
       data="{{data}}">
    </firebase-query>

    <template is="dom-repeat" items="[[data]]" as="tank">
          <blaktip-tank key="[[tank.$key]]" uid="[[user.uid]]" tank="[[tank]]" prefs="[[tank.prefs]]"></blaktip-tank>
    </template>

    <paper-fab
       icon="add"
       on-tap="openDialog"
       disabled="[[!online]]"
       aria-label="Add tank...">
    </paper-fab>

    <!-- <firebase-document
        id="document"
        app-name="blaktip"
        path="[[editableTankId]]"
        data="{{editableTank}}">
    </firebase-document>
 -->
    <firebase-document
           app-name="blaktip"
           id="blaktipTanks"
           path="/users/[[user.uid]]/tanks/"
           data="{{tanksData}}">
    </firebase-document>

   <!--  <blaktip-tank-editor
        id="editor"
        note="{{editableTank}}"
        on-close="commitChange">
    </blaktip-tank-editor> -->

    <paper-dialog id="addTankDialog" heading="Add a Tank" transition="core-transition-bottom" modal>
      <form id="addForm" is="iron-form">
        <!-- <paper-input id="name" label="Name" value=""></paper-input>
        <paper-input id="desc" label="Description" value=""></paper-input> -->
        <paper-input id="name" label="Name" value="{{tanksData.name}}"></paper-input>
        <paper-input id="desc" label="Description" value="{{tanksData.desc}}"></paper-input>
        <paper-input id="dateAdded" value="{{tanksData.dateAdded}}" hidden></paper-input>
      </form>
      <paper-button dialog-confirm autofocus on-click="submitTank">Add</paper-button>
      <paper-button dialog-dismiss>Cancel</paper-button>
    </paper-dialog>



  </template>

  <script>
    Polymer({
      is: 'tanks-view',

      behaviors: [
          Polymer.BlaktipTankBehavior
        ],

      _firebaseLoaded: function() {
      if(!this.tanksData) {
         this.set('tanksData', {});
        }
      },

      openDialog: function() {
         this.$.addTankDialog.open();
        }, 

      closeDialog: function() {
         this.$.addTankDialog.close();
        }, 


      submitTank: function() {
        if (!this.$.name.value.length) {
           alert('Please write a title.');
           return;
        }

        if (!this.$.desc.value.length) {
            alert('Please write a question.');
            return;
        }

        // this.$.tanksData.name = this.$.name.value;
        // this.$.tanksData.desc = this.$.desc.value;

        var time = new Date().getTime();
        var date = new Date(time);

        this.$.dateAdded.value = date.toString();

        var promise2 = this.$.blaktipTanks.save(`/users/${this.user.uid}/tanks/`,null);

        console.log("Added tank: "+date.toString());
      

        // var question = this.$.blaktipTanks.save({
        // name: this.$.title.innerText,
        // desc: this.$.content.innerText,
        // user: {
        //    uid: this.globals.user.uid
        //    // username: this.globals.currentUser.github.username,
        //    // avatar_url: this.globals.currentUser.github.cachedUserProfile.avatar_url,
        //    // html_url: this.globals.currentUser.github.cachedUserProfile.html_url
        // },
        timestamp: new Date().getTime();
        //this.$.addForm.reset();
        this.closeDialog();
        location.reload();
        // });


        this.$.name = null;
        this.$.desc = null;
      },


      get tanksPath() {
          return `/users/${this.user.uid}/tanks/`;
        },

      toEditableId(tankId) {
          return `${this.tanksPath}/${tankId}`;
        },
    });
  </script>
</dom-module>
